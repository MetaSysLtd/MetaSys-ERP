Below is a single, copyâ€‘ready â€œProductâ€‘Manager Instruction Blockâ€ you can hand toâ€¯Replitâ€‘Bot.
It rewires the whole CRM foundation without touching styling or deleting existing code.


---

ğŸ”· BLOCK â€“â€¯CRM FOUNDATIONAL REFACTOR (StepÂ 8â€¯Â·â€¯75)

0.â€¯Nonâ€‘negotiables

1. Doâ€¯not delete existing data models or UI components that already work.


2. Preserve branding / animations already in place.


3. All changes must be guarded by unit tests and pushed to Git (feat/crm-refactor) only after tests pass.




---

1.â€¯Lead Object Redesign

> Activity object: {type:'call'|'email'|'note'|'statusChange', userId, timestamp, payload}



Add Drizzle migration.


---

2.â€¯Newâ€‘Lead Modal (CRMâ€¯>â€¯Leads)

Replace current modal with twoâ€‘step form:

1. Company & contact info


2. Logistics info (truckType, mcNumber, mcAge, notes)



Validate all required fields client + server.

Autoâ€‘populate mcAgeMonths via simple external API stub (placeholder).



---

3.â€¯SQL vsâ€¯MQL Flow

1. Manual (SQL) â†’ created via form above.


2. Automatic (MQL) â†’ stub endpoint POST /api/mql/webhook.

Accepts JSON payload {companyName, contactName, phone, email, truckType, sourceForm}.

Creates lead with source='MQL', status='New', ownerId = salesâ€‘unassigned.



3. Add â€œSourceâ€ pill in Leads table & Kanban card.




---

4.â€¯Activity Feed

New reusable <Timeline /> component inside /components/crm/.

Shows last 50 activities (reverse chrono).

Append entry whenever:

Lead created

Status changes

Call logged (callAttempts++)

Note added




---

5.â€¯Handâ€‘off Guardrail

Rule: Lead can move to HandToDispatch only if callAttempts >=â€¯3 and mcNumber present.

Enforce in backend PATCH /api/leads/:id/status with error codeâ€¯412 PRECONDITION_FAILED.


When status becomes HandToDispatch:

1. Emit WebSocket event {type:'lead-handoff', leadId} to â€œdispatchâ€ channel.


2. Autoâ€‘create Dispatcher notification row.




---

6.â€¯CRM Sidebar & Permissions

6.1 Navigation

CRM
 â”œâ”€ Leads
 â”œâ”€ Accounts      (rename â€œClientsâ€ â†’ â€œAccountsâ€ for sales)
 â””â”€ Commissions
Dispatch
 â”œâ”€ Loads
 â”œâ”€ Clients       (move current full client sheet here)
 â”œâ”€ Commissions
 â””â”€ Tracking

Remove â€œCreate Loadâ€ button from CRMÂ >Â Accounts.

Add it only in DispatchÂ >Â Clients row menu.


6.2 Role Access Matrix (enforce via middleware)


---

7.â€¯Settingsâ€¯>â€¯Profile Page (basic)

(Already defined in stepâ€¯8.75 but required for testing)

Allow user to upload avatar, change password.

Username/email editable only by Systemâ€¯Admin.



---

8.â€¯Testing Checklist (must pass before merge)

1. Create SQL lead â†’ appears in list, statusÂ New, activity recorded.


2. Patch callAttempts toâ€¯3 â†’ move status toâ€¯HandToDispatch succeeds.


3. Attempt handâ€‘off with callAttempts<3 â†’ returnsÂ 412.


4. POST MQL webhook â†’ lead created with source MQL.


5. Sales user cannot see revenue columns in Accounts.


6. Dispatch user sees â€œCreate Loadâ€ under Dispatchâ€¯>â€¯Clients, not in CRM.




---

9.â€¯Git Commit Sequence

1. feat(db): migrate leads schema v2 (source, mcAge, timeline)


2. feat(api): lead create & webhook endpoints


3. feat(crm): new lead modal + validation


4. feat(dispatch): move full client sheet, remove load btn from CRM


5. feat(auth): role-based middleware matrix


6. test(crm): unit tests for handoff guardrail




---

ENDâ€¯OFâ€¯BLOCK

Copyâ€‘paste the entire block to Replitâ€‘Bot.
After it ships & you verify, come back with results and weâ€™ll proceed to Stepâ€¯8.9 (GPSâ€¯clockâ€‘in).

