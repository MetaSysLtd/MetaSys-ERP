ğŸ“‘â€¯Productâ€‘Spec Addâ€‘On â€” â€œDynamic Commission Policy Editorâ€

(Copyâ€“paste everything in the grey block to Replitâ€‘Bot. No lineâ€‘breaks omitted.)

GOAL
â€¢ Give users with role = Systemâ€¯Admin (or Financeâ€‘Admin) a safe UI to CREATE / EDIT / ARCHIVE commission rules
  without touching code. All downstream calculations (monthly cron, dashboards, exports) must pick up the
  latest active policy automatically.

SCOPE
A. Dispatchâ€‘Sales commission table & bonuses defined in the prior spec
B. Future: allow additional policies (e.g., Dispatchâ€‘Agent, SaaSâ€‘Sales) â€” make the model generic

REQUIREMENTS
1. DB MODEL
   â€¢ table commission_policy
     - id (uuid) PK
     - name varchar              â†’ e.g., â€œDispatchâ€‘Sales v2024â€‘05â€
     - scope enum                â†’ (â€œdispatch_salesâ€, â€œdispatch_agentâ€, â€œsaas_salesâ€â€¦)
     - jsonb rules               â†’ stores tiers, bonuses, split rules, formulas
     - is_active boolean         â†’ only one active per scope
     - valid_from date, valid_to date nullable
     - created_by, created_at, updated_at

2. ADMIN UI
   Path:  **Admin Panel â–¸ Compensation â–¸ Commission Policies**
   a. List View
      â–ª columns: Name | Scope | Active? | Valid From | Valid To | Actions(edit/duplicate/archive)
   b. Editor Modal
      â–ª Stepâ€‘wizard style
        â‘  Basic info  (name, scope, effectiveÂ dates, active toggle)
        â‘¡ Tiers table:
           â€¢ rows: â€œMin Active Leadsâ€ & â€œCommission PKRâ€
           â€¢ add / delete rows
        â‘¢ Adjustments:
           â€¢ Starter % / Closer %
           â€¢ Inbound multiplier
        â‘£ Bonuses:
           checkbox + amount fields for
           â€¢ Sales Rep of Month
           â€¢ Active Trucks > N
           â€¢ Team Lead after target
        â‘¤ Preview JSON + â€œValidateâ€ (runs clientâ€‘side lint â†’ schema)
      â–ª Save â†’ POST /api/admin/commissionâ€‘policies (create draft)  
      â–ª Publish â†’ sets is_active true; automatically sets previous active to false (same scope)

   âš ï¸Â Guardâ€‘rails  
   â€¢ Cannot delete an active policy; must â€œArchiveâ€ (sets valid_to = yesterday, is_active=false).  
   â€¢ Validation: tiers must be ascending by MinÂ Leads, bonus amounts â‰¥â€¯0,Â  percentages 0â€‘100.  

3. BACKâ€‘END IMPACT
   â€¢ Cron job & realâ€‘time commission previews must query the **currently active policy** by scope & date.
   â€¢ Use policy.rules JSON to compute payouts; no magic numbers in code.
   â€¢ On historical months always pick policy whose valid_from/valid_to span that month.

4. PERMISSIONS
   â€¢ Only roles: SYSTEM_ADMIN, FINANCE_ADMIN can view / edit policies.
   â€¢ READâ€‘ONLY view for DISPATCH_MANAGER and SALES_MANAGER.

5. MIGRATIONS
   â€¢ Seed with initial policy â€œDispatchâ€‘Sales v1â€ containing the table & bonuses already coded.
   â€¢ Write migration/fallback so if no active policy exists â†’ abort commissionâ€‘run & alert admins.

6. UI/UX POLISH
   â€¢ Show a yellow â€œThis is a Draft, not Activeâ€ banner inside editor until published.
   â€¢ Changes propagate next time cron runs; cron logs which policy ID used.
   â€¢ Dashboard badge shows â€œPolicy: Dispatchâ€‘Sales v2024â€‘05â€.

7. ACCEPTANCE TEST
   â–¡ Create a clone of current policy, modify tier 3 amount, publish â†’ cron should pay new amount.  
   â–¡ Archive policy â†’ next cron should fail with â€œNo active policyâ€, notification to Slack #alerts.  
   â–¡ Attempt edit by normal â€œSales_Agentâ€ â†’ 403 Forbidden.

DELIVERABLE
Return `PASS: Dynamic commission policy editor deployed` after UI + API + migration complete and tests pass.


---

Why this matters

Puts compensation control in business hands, not devs

Prevents accidental breakage: rules live in JSON, validated, versioned

Futureâ€‘proof: same framework can power Dispatcher agent commissions, bonuses, etc.


Once Replitâ€‘Bot confirms completion and youâ€™ve verified in the Admin Panel, we can continue to the next step.

